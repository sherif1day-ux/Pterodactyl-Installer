#!/bin/bash
set -e

clear
echo "==============================================="
echo "      REVIACYTL ONLY INSTALLER"
echo "   REQUIRE: PTERODACTYL INSTALLED"
echo "        HTTP ONLY ‚Ä¢ NO SSL"
echo "==============================================="
echo

# ================= ROOT CHECK =================
if [ "$EUID" -ne 0 ]; then
  echo "‚ùå Jalankan sebagai root"
  exit 1
fi

# ================= INPUT USER =================
read -p "Direktori Pterodactyl [/var/www/pterodactyl]: " PANEL_DIR
PANEL_DIR=${PANEL_DIR:-/var/www/pterodactyl}

read -p "Versi PHP (8.1 / 8.2) [8.2]: " PHP_VERSION
PHP_VERSION=${PHP_VERSION:-8.2}

# ================= VALIDATION =================
if [ ! -f "${PANEL_DIR}/artisan" ]; then
  echo "‚ùå Pterodactyl tidak ditemukan di ${PANEL_DIR}"
  echo "   Install Pterodactyl terlebih dahulu!"
  exit 1
fi

if [ ! -f "${PANEL_DIR}/config/pterodactyl.php" ]; then
  echo "‚ùå Ini bukan instalasi Pterodactyl yang valid"
  exit 1
fi

echo "‚úÖ Pterodactyl terdeteksi"

# ================= VARIABLE =================
REVIACTYL_REPO="https://github.com/reviactyl/panel.git"
BACKUP_DIR="/root/backup-reviactyl-$(date +%Y%m%d%H%M)"

# ================= DEPENDENCY =================
echo "üì¶ Pastikan dependency tersedia"
apt update -y
apt install -y git curl unzip zip nodejs npm build-essential

npm install -g yarn

# ================= BACKUP =================
echo "üìÅ Backup panel (resources & public)"
mkdir -p ${BACKUP_DIR}
cp -r ${PANEL_DIR}/resources ${BACKUP_DIR}/
cp -r ${PANEL_DIR}/public ${BACKUP_DIR}/
echo "‚úÖ Backup tersimpan di ${BACKUP_DIR}"

# ================= INSTALL THEME =================
echo "üé® Install Reviactyl"
cd /tmp
rm -rf reviactyl
git clone ${REVIACTYL_REPO} reviactyl

echo "üé® Replace resources"
cp -r reviactyl/resources/* ${PANEL_DIR}/resources/

echo "üé® Replace public assets"
cp -r reviactyl/public/* ${PANEL_DIR}/public/

# ================= BUILD FRONTEND =================
echo "üèóÔ∏è Build frontend"
cd ${PANEL_DIR}
yarn install --production=false
yarn build

# ================= CACHE =================
echo "üßπ Clear & optimize"
php artisan view:clear
php artisan config:clear
php artisan route:clear
php artisan optimize:clear

# ================= PERMISSION =================
echo "üîê Fix permission"
chown -R www-data:www-data ${PANEL_DIR}
chmod -R 755 ${PANEL_DIR}

# ================= SERVICE =================
systemctl restart php${PHP_VERSION}-fpm || true
systemctl restart redis-server || true

echo
echo "==============================================="
echo "‚úÖ REVIACYTL BERHASIL DIPASANG"
echo "üìå Panel tetap Pterodactyl (theme only)"
echo "üîí SSL : DISABLED"
echo "==============================================="
