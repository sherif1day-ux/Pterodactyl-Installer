#!/bin/bash
set -e

clear
echo "==============================================="
echo "   REVIACYTL ONLY INSTALLER (FIXED VERSION)"
echo "   REQUIRE: PTERODACTYL INSTALLED"
echo "   HTTP ONLY ‚Ä¢ NO SSL"
echo "==============================================="
echo

# ================= ROOT CHECK =================
if [ "$(id -u)" -ne 0 ]; then
  echo "‚ùå Jalankan script sebagai root"
  exit 1
fi

# ================= INPUT USER =================
read -p "Direktori Pterodactyl [/var/www/pterodactyl]: " PANEL_DIR
PANEL_DIR="${PANEL_DIR:-/var/www/pterodactyl}"

read -p "Versi PHP (8.1 / 8.2) [8.2]: " PHP_VERSION
PHP_VERSION="${PHP_VERSION:-8.2}"

echo

# ================= VALIDATION =================
if [ ! -d "$PANEL_DIR" ]; then
  echo "‚ùå Direktori tidak ditemukan: $PANEL_DIR"
  exit 1
fi

if [ ! -f "$PANEL_DIR/artisan" ]; then
  echo "‚ùå File artisan tidak ditemukan"
  echo "   Ini bukan instalasi Pterodactyl"
  exit 1
fi

if [ ! -d "$PANEL_DIR/resources" ] || [ ! -d "$PANEL_DIR/public" ]; then
  echo "‚ùå Struktur Pterodactyl tidak valid"
  exit 1
fi

echo "‚úÖ Pterodactyl terdeteksi di $PANEL_DIR"

# ================= VARIABLE =================
REVIACTYL_REPO="https://github.com/reviactyl/panel.git"
BACKUP_DIR="/root/backup-reviactyl-$(date +%Y%m%d%H%M)"

# ================= DEPENDENCY =================
echo "üì¶ Pastikan dependency tersedia"
apt update -y
apt install -y git curl unzip zip nodejs npm build-essential

if ! command -v yarn >/dev/null 2>&1; then
  npm install -g yarn
fi

# ================= BACKUP =================
echo "üìÅ Backup resources & public"
mkdir -p "$BACKUP_DIR"
cp -r "$PANEL_DIR/resources" "$BACKUP_DIR/"
cp -r "$PANEL_DIR/public" "$BACKUP_DIR/"
echo "‚úÖ Backup tersimpan di $BACKUP_DIR"

# ================= INSTALL REVIACYTL =================
echo "üé® Download Reviactyl"
cd /tmp
rm -rf reviactyl
git clone "$REVIACTYL_REPO" reviactyl

echo "üé® Replace resources"
cp -r reviactyl/resources/* "$PANEL_DIR/resources/"

echo "üé® Replace public assets"
cp -r reviactyl/public/* "$PANEL_DIR/public/"

# ================= BUILD FRONTEND =================
echo "üèóÔ∏è Build frontend"
cd "$PANEL_DIR"

yarn install --production=false
yarn build

# ================= CLEAR CACHE =================
echo "üßπ Clear cache"
php artisan view:clear
php artisan config:clear
php artisan route:clear
php artisan optimize:clear

# ================= PERMISSION =================
echo "üîê Fix permission"
chown -R www-data:www-data "$PANEL_DIR"
chmod -R 755 "$PANEL_DIR"

# ================= SERVICE =================
if systemctl list-units --type=service | grep -q "php${PHP_VERSION}-fpm"; then
  systemctl restart "php${PHP_VERSION}-fpm"
fi

systemctl restart redis-server || true

echo
echo "==============================================="
echo "‚úÖ REVIACYTL BERHASIL DIPASANG (FIXED)"
echo "üìå Pterodactyl aman, theme aktif"
echo "==============================================="
